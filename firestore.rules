rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Regra para a coleção de usuários
    // Permite que um usuário autenticado crie seu próprio documento.
    // Apenas o próprio usuário pode ler, atualizar ou deletar seu documento.
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;
    }

    // Regra para a coleção de produtos
    match /products/{productId} {
      // Qualquer usuário autenticado pode ler a lista de produtos.
      allow read: if request.auth != null;
      
      // Qualquer usuário autenticado pode criar um produto.
      allow create: if request.auth != null;
      
      // Apenas o dono do produto (ownerId) pode atualizá-lo ou excluí-lo.
      allow update, delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    // Regra para a coleção de categorias
    match /categories/{categoryId} {
      // Qualquer usuário autenticado pode ler a lista de categorias.
      allow read: if request.auth != null;
      
      // Qualquer usuário autenticado pode criar uma categoria.
      allow create: if request.auth != null;
      
      // Apenas o criador da categoria (createdBy) pode atualizá-la ou excluí-la.
      allow update, delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }

    // Regra para a coleção de listas e seus itens
    match /lists/{listId} {
      // Leitura: Qualquer membro da lista pode ler.
      allow read: if request.auth != null && request.auth.uid in resource.data.memberUIDs;

      // Criação: Qualquer usuário autenticado pode criar, definindo-se como dono.
      allow create: if request.auth != null
                    && request.resource.data.ownerId == request.auth.uid;

      // Atualização: O dono ou um editor pode atualizar a lista.
      allow update: if request.auth != null
                    && (resource.data.ownerId == request.auth.uid || resource.data.memberPermissions[request.auth.uid] == 'editor');

      // Exclusão: Apenas o dono pode excluir a lista.
      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;

      // Regras para a subcoleção de itens
      match /items/{itemId} {
        // Leitura: Se pode ler a lista, pode ler os itens.
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/lists/$(listId)).data.memberUIDs;

        // Escrita (Criar, Atualizar, Excluir): O dono ou um editor da lista pode gerenciar os itens.
        allow write: if request.auth != null
                     && (get(/databases/$(database)/documents/lists/$(listId)).data.ownerId == request.auth.uid || get(/databases/$(database)/documents/lists/$(listId)).data.memberPermissions[request.auth.uid] == 'editor');
      }
    }
  }
}